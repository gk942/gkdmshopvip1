<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Trang Qu·∫£n Tr·ªã Admin</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #1e1e2f;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #00ffc8;
    }
    #adminSection {
      display: none;
      margin-top: 20px;
    }
    #loginSection {
      text-align: center;
      margin-top: 50px;
    }
    input[type="password"] {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      width: 250px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background-color: #00ffc8;
      color: #000;
      cursor: pointer;
      margin-left: 10px;
    }
    button:hover {
      background-color: #00cca3;
    }
    table {
      width: 100%;
      margin-top: 30px;
      border-collapse: collapse;
      background-color: #292940;
    }
    th, td {
      border: 1px solid #444;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #00ffc8;
      color: #000;
    }
    td button {
      background-color: #28c76f;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    td button:hover {
      background-color: #20b265;
    }
  </style>
</head>
<body>
  <h1>üõ†Ô∏è TRANG QU·∫¢N TR·ªä ADMIN</h1>

  <div id="loginSection">
    <input type="password" id="adminPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u admin...">
    <button onclick="checkAdmin()">üîê ƒêƒÉng nh·∫≠p</button>
  </div>

  <div id="adminSection">
    <h2>üìã Danh s√°ch giao d·ªãch ch·ªù duy·ªát</h2>
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>N·ªôi dung</th>
          <th>S·ªë ti·ªÅn</th>
          <th>Th·ªùi gian</th>
          <th>Tr·∫°ng th√°i</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="lichsugiaodich">
        <tr><td colspan="6">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDBaWDDCkhRa3DQcJBYdznL98GjHmXspuI",
      authDomain: "gkdmshop.firebaseapp.com",
      databaseURL: "https://gkdmshop-default-rtdb.firebaseio.com",
      projectId: "gkdmshop",
      storageBucket: "gkdmshop.appspot.com",
      messagingSenderId: "52437838526",
      appId: "1:52437838526:web:3187795557aa1458190cef",
      measurementId: "G-V4QFPWK82L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function checkAdmin() {
      const input = document.getElementById("adminPassword").value;
      if (input === "Maka26042006") {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("adminSection").style.display = "block";
        loadGiaoDich();
      } else {
        alert("‚ùå Sai m·∫≠t kh·∫©u qu·∫£n tr·ªã.");
      }
    }

    window.checkAdmin = checkAdmin;

    function loadGiaoDich() {
      const giaoDichRef = ref(db, 'giaodich');
      onValue(giaoDichRef, (snapshot) => {
        const data = snapshot.val();
        const table = document.getElementById("lichsugiaodich");
        table.innerHTML = "";

        if (data) {
          Object.keys(data).forEach(uid => {
            Object.keys(data[uid]).forEach(key => {
              const item = data[uid][key];
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${item.email}</td>
                <td>${item.noidung}</td>
                <td>${item.sotien}</td>
                <td>${item.thoigian}</td>
                <td class="trangthai">${item.trangthai}</td>
                <td>
                  ${item.trangthai === "ƒëang ch·ªù"
                    ? `<button onclick="duyetGiaoDich('${uid}', '${key}', ${item.sotien}, this)">‚úÖ Duy·ªát</button>`
                    : "‚úÖ ƒê√£ duy·ªát"}
                </td>
              `;
              table.appendChild(row);
            });
          });
        } else {
          table.innerHTML = "<tr><td colspan='6'>Kh√¥ng c√≥ giao d·ªãch n√†o</td></tr>";
        }
      });
    }

    window.duyetGiaoDich = async function (uid, key, sotien, button) {
      try {
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i giao d·ªãch
        await update(ref(db, `giaodich/${uid}/${key}`), {
          trangthai: "th√†nh c√¥ng"
        });

        // L·∫•y s·ªë d∆∞ hi·ªán t·∫°i
        const soduSnap = await get(ref(db, `users/${uid}/sodu`));
        const currentSodu = soduSnap.exists() ? Number(soduSnap.val()) : 0;
        const newSodu = currentSodu + Number(sotien);

        // C·∫≠p nh·∫≠t s·ªë d∆∞
        await update(ref(db, `users/${uid}`), {
          sodu: newSodu
        });

        // C·∫≠p nh·∫≠t giao di·ªán
        const row = button.parentElement.parentElement;
        row.querySelector(".trangthai").innerText = "th√†nh c√¥ng";
        button.outerHTML = "‚úÖ ƒê√£ duy·ªát";
        alert("‚úÖ Giao d·ªãch ƒë√£ duy·ªát & c·ªông ti·ªÅn!");
      } catch (err) {
        console.error("‚ùå L·ªói khi duy·ªát:", err);
        alert("‚ùå C√≥ l·ªói x·∫£y ra khi duy·ªát giao d·ªãch.");
      }
    };
  </script>
</body>
</html>
